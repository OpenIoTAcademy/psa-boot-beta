
#include "boot_upgrade_package.h"

#include "boot_security.h"

#include "hal_timer.h"
#include "hal_log.h"

#include "aes.h"

#define PSA_VERSION_VER_MAJOR			0
#define PSA_VERSION_VER_MINOR			1

bool check_for_upgrade(void)
{
	return true;
}

uint32_t get_upgrade_package_offset(void)
{
	{
#if 0
		/* Test code to remove */
		static uint8_t buffer[4 * 1024];
		boot_upgrade_package_t* package = (boot_upgrade_package_t*)buffer;

		strcpy((char*)buffer, "ZAYA");
		package->metadata.size = 128;
#else
		static uint8_t buffer[] = {
			// Prefix : ZAYA
			0x5A, 0x41, 0x59, 0x41,
			// Version
			0x01, 0x00, 0x00, 0x00,
			// Size
			0x20, 0x00, 0x00, 0x00,
			// Reserved
			0x00, 0x00, 0x00, 0x00,
			// IV
			0x86, 0x95, 0x06, 0xBE, 0xEE, 0x23, 0x7A, 0x29, 0x6A, 0x47, 0xA6, 0x3C, 0x73, 0xE1, 0x6B, 0x0A,
			// Signature
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			// Encrypted Image
			0xD0, 0x43, 0x6B, 0x83, 0xFA, 0xC3, 0x12, 0xE6, 0xC4, 0x9C, 0xD8, 0xE5, 0x77, 0xCC, 0x09, 0x82,
			0xED, 0xEF, 0xCA, 0x46, 0x9F, 0x27, 0xB7, 0xF2, 0x5F, 0xF9, 0x50, 0xDC, 0x42, 0x6A, 0xF6, 0xFF };
#endif

		return (uint32_t)buffer;
	}
}

void jump_to_latest_image(void)
{
	LOG_PRINTF(" >> BOOT : Application is being started!");
	while (1);
}

int main(void) {

	/* Let us wait for a while; because the UI may not be ready yet to send logs. */
	hal_timer_sleep(100);

	LOG_PRINTF("psa-boot v%d.%d", PSA_VERSION_VER_MAJOR, PSA_VERSION_VER_MINOR);

	if (check_for_upgrade())
	{
		uint32_t package_offset = get_upgrade_package_offset();

		boot_upgrade_package_t* upgrade_package = (boot_upgrade_package_t*)package_offset;

		if (boot_authenticate_upgrade_package(upgrade_package)) 
		{
			LOG_PRINTF(" >> BOOT : Upgrade package authentication : SUCCESS");
			boot_decrypt_upgrade_package(upgrade_package);

			LOG_PRINTF(" >> BOOT : Upgrade package decryption : SUCCESS");
		}
		else
		{
			LOG_PRINTF(" >> BOOT : Upgrade package authentication failed!");
		}
	}

	jump_to_latest_image();

	return 0;
}
